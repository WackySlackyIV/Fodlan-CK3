namespace = fodlan_event_battle


# Generic event battle main loop
# You should only have 1 instance of a major event battle happening at a time since we use global variables.
# TODO: Documenting expected global variables that exist
fodlan_event_battle.1 = {
  type = character_event
  title = fodlan_event_battle.1.t
  desc = fodlan_event_battle.1.desc

  theme = war

  left_portrait = {
    character = global_var:fodlan_event_battle_attacker
    animation = war_attacker
  }
  right_portrait = {
    character = global_var:fodlan_event_battle_defender
    animation = war_defender
  }

  immediate = {
    # Sets up variables for localization
    root = {
			save_scope_as = char
			scope:char = { # Copy variables for string localization
				set_variable = {
					name = local_battlefield
					value = global_var:fodlan_event_battle_battlefield
				}
        set_variable = {
          name = local_round
          value =  global_var:fodlan_event_battle_round
        }
        set_variable = {
          name = local_max_round
          value =  global_var:fodlan_event_battle_max_rounds
        }
			}
		}
    global_var:fodlan_event_battle_location = {
      save_scope_as = local_battle_location
    }
    global_var:fodlan_event_battle_left_attacking_army = {
      save_scope_as = local_left_attacking_army
    }
    global_var:fodlan_event_battle_center_attacking_army = {
      save_scope_as = local_center_attacking_army
    }
    global_var:fodlan_event_battle_right_attacking_army = {
      save_scope_as = local_right_attacking_army
    }
    global_var:fodlan_event_battle_left_defending_army = {
      save_scope_as = local_left_defending_army
    }
    global_var:fodlan_event_battle_center_defending_army = {
      save_scope_as = local_center_defending_army
    }
    global_var:fodlan_event_battle_right_defending_army = {
      save_scope_as = local_right_defending_army
    }
  }

  option = {
    trigger = {
      is_ai = no
    }
    name = "Help (See Tooltip)"
    custom_tooltip = fodlan_event_battle.1.help.1
    custom_tooltip = fodlan_event_battle.1.help.2
    custom_tooltip = fodlan_event_battle.1.help.3
    custom_tooltip = fodlan_event_battle.1.help.4
    custom_tooltip = fodlan_event_battle.1.help.5
    custom_tooltip = fodlan_event_battle.1.help.6
    show_as_unavailable = { always = yes }
    hidden_effect = {
      root = {
        trigger_event = {
          id = fodlan_event_battle.1
        }
      }
    }
    ai_chance = {
      base = 0
    }
  }

  option = {
    trigger = {
      is_ai = no
      # variable_list_size = { name = fodlan_event_battle_reserve_armies value > 0 }
      has_deployable_reserves = yes
    }
    name = "Deploy Reserves"
    hidden_effect = {
      root = {
        trigger_event = {
          id = fodlan_event_battle.2
        }
      }
    }
    ai_chance = {
      base = 0
    }
  }

  option = {
    trigger = {
      is_ai = no
    }
    name = "Perform Action"
    hidden_effect = {
      root = {
        trigger_event = {
          id = fodlan_event_battle.4
        }
      }
    }
    ai_chance = {
      base = 0
    }
  }

  option = {
    trigger = {
      is_ai = no
    }
    name = "Wait (Ends Round)"
    go_to_next_participant = yes
    ai_chance = {
      base = 0
    }
  }

  option = {
    trigger = {
      is_ai = yes
    }
    calculate_ai_action = yes
    ai_chance = {
      base = 100
    }
  }
}

scripted_trigger has_deployable_reserves = {
  variable_list_size = { name = fodlan_event_battle_reserve_armies value > 0 }
}

scripted_effect go_to_next_participant = {
  if = {
    limit = {
      global_variable_list_size = { name = fodlan_event_battle_remaining_round_participants value < 1 }
    }
    go_to_next_round = yes
  }
  else = {
    random_in_global_list = { # TODO: Technically should do in an ordered way
      variable = fodlan_event_battle_remaining_round_participants
      this = {
        remove_list_global_variable = {
          name = fodlan_event_battle_remaining_round_participants
          target = this
        }
        prev = { # TODO: This is for testing only
          set_player_character = prev
        }
        trigger_event = {
          id = fodlan_event_battle.1
        }
      }
    }
  }
}

scripted_effect go_to_next_round = { # TODO
  debug_log = "Calculating Next Round"
  change_global_variable = {
    name = fodlan_event_battle_round
    add = 1
  }
  if = {
    limit = {
      global_var:fodlan_battle_round = {
        compare_value > global_var:fodlan_event_battle_max_rounds
      }
    }
    end_battle = yes
  }
  else = {
    debug_log = "Setting up Next Round"
    every_in_global_variable_list = {
      variable = fodlan_event_battle_participants
      debug_log_scope = no
      add_to_global_variable_list = { name = fodlan_event_battle_remaining_round_participants target = this }
    }
    calculate_damages = yes
    go_to_next_participant = yes
  }
}

scripted_effect end_battle = {
  debug_log = "Calculating End Battle"# TODO
}

scripted_effect calculate_ai_action = { # TODO
  debug_log = "Calculating the AI action"
  go_to_next_participant = yes
}

scripted_effect calculate_damages = { # TODO
  debug_log = "Calculating Damages to each army"
}

fodlan_event_battle.2 = {
  type = character_event
  title = fodlan_event_battle.2.t
  desc = fodlan_event_battle.2.desc

  theme = war

  left_portrait = {
    character = global_var:fodlan_event_battle_attacker
    animation = war_attacker
  }
  right_portrait = {
    character = global_var:fodlan_event_battle_defender
    animation = war_defender
  }

  option = {
    name = "Left" 
    hidden_effect = {
      set_variable = {
        name = local_redeploy_flank
        value = 1
      }
      root = {
        trigger_event = {
          id = fodlan_event_battle.3
        }
      }
    }
  }

  option = {
    name = "Center"
    hidden_effect = {
      set_variable = {
        name = local_redeploy_flank
        value = 2
      }
      root ={
        trigger_event = {
          id = fodlan_event_battle.3
        }
      }
    }
  }

  option = {
    name = "Right"
    hidden_effect = {
      set_variable = {
        name = local_redeploy_flank
        value = 3
      }
      root = {
        trigger_event = {
          id = fodlan_event_battle.3
        }
      }
    }
  }

  option = {
    name = "Back"
    hidden_effect = {
      root = {
        trigger_event = {
          id = fodlan_event_battle.1
        }
      }
    }
  }
}

# TODO: Need to handle attacker/defender split
# Deploy Reserves to a particular front
fodlan_event_battle.3 = {
  type = character_event
  title = fodlan_event_battle.3.t
  desc = fodlan_event_battle.3.desc

  theme = war

  left_portrait = {
    character = global_var:fodlan_event_battle_attacker
    animation = war_attacker
  }
  right_portrait = {
    character = global_var:fodlan_event_battle_defender
    animation = war_defender
  }

  # TODO: if they have a option list generator would be great
  # TODO: Currently only support up to 4, need to add pagination
  immediate = {
    set_local_variable = { name = temp_iter value = 1 }
    every_in_list = {
      variable = fodlan_event_battle_reserve_armies
      if = {
        limit = { local_var:temp_iter = { compare_value = 1 } }
        save_scope_as = local_first_army
        debug_log = "First Army Immediate"
        debug_log_scopes = no
      }
      if = {
        limit = { local_var:temp_iter = { compare_value = 2 } }
        save_scope_as = local_second_army
        debug_log = "Second Army Immediate"
        debug_log_scopes = no
      }
      if = {
        limit = { local_var:temp_iter = { compare_value = 3 } }
        save_scope_as = local_third_army
        debug_log = "Third Army Immediate"
        debug_log_scopes = no
      }
      if = {
        limit = { local_var:temp_iter = { compare_value = 4 } }
        save_scope_as = local_fourth_army
        debug_log = "Fourth Army Immediate"
        debug_log_scopes = no
      }
      change_local_variable = { name = temp_iter add = 1 }
    }
  }

  option = {
    name = "Back"
    hidden_effect = {
      root = {
        trigger_event = {
          id = fodlan_event_battle.1
        }
      }
    }
  }

  option = {
    name = fodlan_event_battle.3.army.1
    trigger = {
      exists = scope:local_first_army
    }
    if = {
      limit = {
        root.var:local_redeploy_flank = { compare_value = 1 }
      }
      set_global_variable = {
        name = fodlan_event_battle_left_attacking_army
        value = scope:local_first_army
      }
    }
    if = {
      limit = {
        root.var:local_redeploy_flank = { compare_value = 2 }
      }
      set_global_variable = {
        name = fodlan_event_battle_center_attacking_army
        value = scope:local_first_army
      }
    }
    if = {
      limit = {
        root.var:local_redeploy_flank = { compare_value = 3 }
      }
      set_global_variable = {
        name = fodlan_event_battle_right_attacking_army
        value = scope:local_first_army
      }
    }
    remove_list_global_variable = {
      name = fodlan_event_battle_reserve_armies
      target = scope:local_first_army
    }
    go_to_next_participant = yes
  }

  option = {
    name = fodlan_event_battle.3.army.2
    trigger = {
      exists = scope:local_second_army
    }
    if = {
      limit = {
        root.var:local_redeploy_flank = { compare_value = 1 }
      }
      set_global_variable = {
        name = fodlan_event_battle_left_attacking_army
        value = scope:local_second_army
      }
    }
    if = {
      limit = {
        root.var:local_redeploy_flank = { compare_value = 2 }
      }
      set_global_variable = {
        name = fodlan_event_battle_center_attacking_army
        value = scope:local_second_army
      }
    }
    if = {
      limit = {
        root.var:local_redeploy_flank = { compare_value = 3 }
      }
      set_global_variable = {
        name = fodlan_event_battle_right_attacking_army
        value = scope:local_second_army
      }
    }
    remove_list_global_variable = {
      name = fodlan_event_battle_reserve_armies
      target = scope:local_second_army
    }
    go_to_next_participant = yes
  }
}